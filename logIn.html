<!doctype html>
</html>
    <head>
        <meta charset="utf-8">
        <title>登入頁面</title>
        <meta name="description" content="My Parse App">
        <meta name="viewport" content="width=device-width">
        <script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js"></script>
        <script type="text/javascript" src="http://www.parsecdn.com/js/parse-1.4.2.min.js"></script>
        <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.4/css/bootstrap.min.css">
        <script type="text/javascript" src="js/key.js"></script>
        
        <script>
            // Step 4 : 登入
            $(document).on('submit','#logInForm',function(e){
                Parse.User.logOut();
                e.preventDefault();  // 避免 form submit 完成後 轉址
                console.log ("login") ;
                var username = $('#username').val() ;
                var password = $('#password').val() ;

                // 用 Parse.User.current() 判定使用者是否是登入的狀態，這裏還沒登入，會是 null
                console.log("登入之前的 Parse.User.current()  : ", Parse.User.current()) ;

                Parse.User.logIn( username , password , {
                    success: function(user) {
                        // 到 console 看看 Parse.User.current()  的東西
                        console.log("登入之後的 Parse.User.current()  : ",Parse.User.current()) ;
                        alert('登入成功') ;
                        window.location = 'homepage.html' ;
                    },
                    error: function(user,error) {
                        console.log(error) ;
                        alert(error.message);
                    }
                });//endof login
            });  //endof logInBtn onSubmit


            //step1:https://www.parse.com/docs/js/guide#users-facebook-users
            // Initialize Parse
            Parse.initialize("3Ct29PJCet8L8kfhLvbLTJ3DLKRC61RAp7ysXFU6", "3yHxjy4EBgJTMWYBuP1T7rG4qOHiiOuAnokZB5jb");
            window.fbAsyncInit = function() {
                Parse.FacebookUtils.init({ // this line replaces FB.init({
                    appId      : '376624765869068', // Facebook App ID
                    status     : true,  // check Facebook Login status
                    cookie     : true,  // enable cookies to allow Parse to access the session
                   xfbml      : true,  // initialize Facebook social plugins on the page
                    version    : 'v2.3' // point to the latest Facebook Graph API version
                });
              // Run code after the Facebook SDK is loaded.
            };
            (function(d, s, id){
            var js, fjs = d.getElementsByTagName(s)[0];
            if (d.getElementById(id)) {return;}
            js = d.createElement(s); js.id = id;
            js.src = "//connect.facebook.net/en_US/sdk.js";
            fjs.parentNode.insertBefore(js, fjs);
            }(document, 'script', 'facebook-jssdk'));

            function fblogin(){
                //step2:https://developers.facebook.com/docs/graph-api/using-graph-api/v2.3               
                Parse.FacebookUtils.logIn(null, {
                    success: function(user) {
                        if (!user.existed()) {
                          alert("註冊完成並且透過臉書登入");
                        } else {
                          alert("透過臉書登入成功");
                        }
                        indexView();//切換至預先寫好登入後的介面
                        FB.getLoginStatus(function(response) {
                            if (response.status === 'connected') {
                                FB.api('/me/picture?type=large', function (response) {
                                   $('#fbImgView').html("<h5>Here are your profile photo</h5><img src="+response.data.url+" crossorigin=\"anonymous\" id=preview1 />");          
                                });
                                FB.api('/me', function (response) {
                                    console.log(response);
                                    $('#fbImgView').append("<h1>Welcome , "+(response['gender']=="male"?"Mr. ":"Miss ")+" "+response['first_name']+"</h1>");
                                });
                            }
                        }); 
                    },
                    error: function(user, error) {
                        alert("使用者取消登入或沒有授權");
                    }
                });
            }
        </script>

    </head>

    <body>
        <div class="container">
            <div class="row">
                <form id="logInForm" class="form-horizontal">
                    <fieldset>
                        <!-- Form Name -->
                        <legend>登入</legend>

                        <!-- Text input-->
                        <div class="form-group">
                            <label class="col-md-4 control-label" for="username">使用者名稱</label>
                            <div class="col-md-4">
                                <input id="username" name="username" type="text" placeholder="username" class="form-control input-md" required="">
                            </div>
                        </div>

                        <!-- Password input-->
                        <div class="form-group">
                            <label class="col-md-4 control-label" for="password">使用者密碼</label>
                            <div class="col-md-4">
                                <input id="password" name="password" type="password" placeholder="password" class="form-control input-md" required="">
                            </div>
                        </div>

                        <!-- Button -->
                        <div class="form-group">
                            <label class="col-md-4 control-label" for="signUpBtn"></label>
                            <div class="col-md-4">
                                <button id="signUpBtn" name="signUpBtn" class="btn btn-primary">登入</button>
                                <a href="signUp.html" class="btn">註冊</a>
                                <button id="fbloginBtn" class="btn btn-primary" type="submit">臉書登入</button>
                            </div>
                        </div>
                    </fieldset>
                </form>
            </div>
        </div>
    </body>

</html>
